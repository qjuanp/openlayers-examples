<html>
    <head>
    	
    	
    	<script src="http://openlayers.org/api/OpenLayers.js" type="text/javascript"></script>
    	
    	
    	
    	
    	<script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>
    	<script type="text/javascript">
    		var map;
    		var markSt=null, markEnd=null;
    		var lonlatSt = null, lonlatEnd=null;
    		var _markers=null,kmlLayer=null;
    		var bt;
    		
    		function init(){
    			var layers;
    			
    			map = getMap('mapContainer');
    			
    			map.addControl(new OpenLayers.Control.LayerSwitcher());
    			
    			layers = getMapsLayers();
		    	
    			map.addLayers(layers);
    			map.addLayer(getMarkersLayer());
    			
    			map.zoomToMaxExtent();
    			
    			map.events.register('click',map,clickHandler);
    			
    		}
    		
    		function clickHandler(args){
    			var lonlatClicked = map.getLonLatFromViewPortPx(args.xy),
    				markers = getMarkersLayer();   			
    			
    			if(bt == 'st'){
					if(markSt != null){
						markers.removeMarker(markSt);
						markSt.destroy();
						markSt = null;
					}
					
					lonlatSt = getStandardPos(lonlatClicked);
			
					markSt = new OpenLayers.Marker(lonlatClicked);
					markers.addMarker(markSt);
					
					bt = '';
					
					if(markEnd != null)
						drawRoute();
    			}
    			else if(bt=='end'){
    				if(markEnd != null){
						markers.removeMarker(markEnd);
						markEnd.destroy();
						markEnd = null;
					}
					
					lonlatEnd = getStandardPos(lonlatClicked);
					
					markEnd = new OpenLayers.Marker(lonlatClicked);
					markers.addMarker(markEnd);
					
					bt = '';
					
					if(markSt != null)
						drawRoute();
    			}
    		
    		}
    		
    		function drawRoute(){
    			var urlRouteSvc = "http://www.yournavigation.org/api/1.0/gosmore.php?format=kml&v=motorcar&fast=1&layer=mapnik",
    				sm = getLineStyle();
    			
    			urlRouteSvc = urlRouteSvc + "&flon="+lonlatSt.lon+"&flat="+lonlatSt.lat+"&tlon="+lonlatEnd.lon+"&tlat="+lonlatEnd.lat;
    			
    			if(kmlLayer != null){
    				kmlLayer.destroy();
    				kmlLayer = null;
    			}
    			
    			kmlLayer = new OpenLayers.Layer.Vector(
    						"kml",
    						{
    							styleMap : sm,
    							projection: map.displayProjection,
    							strategies: [new OpenLayers.Strategy.Fixed()],
    							protocol: new OpenLayers.Protocol.HTTP(
    							{
    								url: urlRouteSvc,
    								format: new OpenLayers.Format.KML(
    									{
    										extractStyles: true,
											extractAttributes: true,
											maxDepth: 2
    									}
    								)
    							}
    						)
    						}
    			);
    			
    			map.addLayer(kmlLayer);
    			
    		}    		
    		
    		function getMarkersLayer(){
    			if(_markers==null)
    				_markers = new OpenLayers.Layer.Markers("markers");
    				
    			return _markers;
    		}
    		
    		// Obtiene los layers de los diferentes servicios de mapas
    		function getMapsLayers(){
    			var goSat = new OpenLayers.Layer.Google(
        			"Google Satellite",
        			{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:22}
    			),
    			goHy = new OpenLayers.Layer.Google(
        			"Google Hybrid",
        			{type:google.maps.MapTypeId.HYBRID,numZoomLevels:22}
    			),
    			bingRoad = new OpenLayers.Layer.Bing({
                		name: "Bing Road",
                		key: "AoYx0TZvI8ceg0ZL1ZESpqDmgh0ltnPp5XheFiAPL3r4hskqgqLu4MOejhPeBnzP",
                		type: "Road"
            		}),
            	bingAerialWLb = new OpenLayers.Layer.Bing({
                		name: "Bing Aerial with Labels",
                		key: "AoYx0TZvI8ceg0ZL1ZESpqDmgh0ltnPp5XheFiAPL3r4hskqgqLu4MOejhPeBnzP",
                		type: "AerialWithLabels"
            		}),
            	osm = new OpenLayers.Layer.OSM("OpenStreetMaps");
            	
            	return [goSat, goHy, bingRoad, bingAerialWLb, osm];
    		}
    		
    		function getMap(container){
    			var map, controls;
    			
    			controlsToUse = [
    					new OpenLayers.Control.Navigation(), // Permite las funciones basicas de navegacion con el mouse
    					new OpenLayers.Control.MousePosition(), // Muestra la ubicacion del cursor sobre el mapa
    					new OpenLayers.Control.PanZoomBar(), // Controles para el manejo del Zoom y navegacion visual
						new OpenLayers.Control.ScaleLine(), // Escala
    					new OpenLayers.Control.OverviewMap(), // Muestra un mapa pequeño que facilita la navegación en el mapa
    					new OpenLayers.Control.KeyboardDefaults() // Navegar en el mapa con el tecaldo
    			];
    			
    			map = new OpenLayers.Map(container,{controls:controlsToUse});
    			
    			return map;
    		}
    		
    		function getLineStyle(){
    			var defStyle = {strokeColor: "blue", strokeOpacity: "0.7", strokeWidth: 3, cursor: "pointer"};
				var sty = OpenLayers.Util.applyDefaults(defStyle, OpenLayers.Feature.Vector.style["default"]);
				var sm = new OpenLayers.StyleMap({
					'default': sty,
					'select': {strokeColor: "red", fillColor: "red"}
					});
				return sm;
    		}    		
    		
    		function getStandardPos(lonlat){
    			var lonlatTrans = new OpenLayers.LonLat(lonlat.lon,lonlat.lat);
    			
    			return lonlatTrans.transform(
										new OpenLayers.Projection("EPSG:900913"),
										new OpenLayers.Projection("EPSG:4326"));
    		}
    	</script>
    	
    	<style type="text/css">
    		html, body, #mapContainer {
    			margin:0;
    			width:100%;
    			height:100%;
    		}
    	</style>
    </head>
    <body onload="init()">
    	<div id="mapContainer" />
    	<input type="button" value="Punto" onclick="javascript: bt='st';">
		<input type="button" value="Destino" onclick="javascript: bt='end';">
    </body>
</html>